# Nombre del flujo de trabajo que se mostrará en la pestaña "Actions" de GitHub.
name: CI de VoxFlow

# Define los eventos que activarán la ejecución de este flujo de trabajo.
on:
  # Se ejecuta cuando se hace un push a cualquier rama.
  push:
    branches: [ main, feature/** ]
  # También se ejecuta cuando se crea o actualiza un Pull Request dirigido a la rama main.
  pull_request:
    branches: [ main ]

# Define los trabajos (jobs) que se ejecutarán como parte del flujo de trabajo.
jobs:
  # Definimos un único trabajo llamado 'build-and-test'.
  build-and-test:
    # Especifica el tipo de máquina virtual en la que se ejecutará el trabajo.
    # 'ubuntu-latest' utiliza la última versión estable de Ubuntu LTS.
    runs-on: ubuntu-latest

    # Define los pasos (steps) que componen el trabajo. Se ejecutan en secuencia.
    steps:
      # Paso 1: Clonar el repositorio.
      # Utiliza una acción preconstruida (actions/checkout@v3) para descargar el código del repositorio
      # en la máquina virtual del runner.
      - name: Clonar el repositorio
        uses: actions/checkout@v3

      # Paso 2: Configurar el entorno de Python.
      # Utiliza la acción 'actions/setup-python@v4' para instalar una versión específica de Python.
      - name: Configurar Python 3.9
        uses: actions/setup-python@v4
        with:
          # Especificamos la versión de Python que queremos usar.
          python-version: '3.9'

      # Paso 3: Instalar dependencias del sistema.
      # Antes de instalar las bibliotecas de Python, necesitamos asegurarnos de que las dependencias
      # a nivel del sistema operativo estén presentes.
      - name: Instalar dependencias del sistema (PortAudio)
        run: |
          # Actualizamos la lista de paquetes de apt.
          sudo apt-get update
          # Instalamos la biblioteca de desarrollo de PortAudio, necesaria para 'sounddevice'.
          sudo apt-get install -y portaudio19-dev

      # Paso 4: Instalar las dependencias de Python.
      # Este paso instala todas las bibliotecas listadas en el archivo requirements.txt.
      - name: Instalar dependencias de Python
        run: |
          # Actualizamos pip a su última versión.
          python -m pip install --upgrade pip
          # Instalamos todas las dependencias del proyecto.
          pip install -r requirements.txt

      # Paso 5: Ejecutar las pruebas con pytest.
      # Este es el paso final de verificación.
      - name: Ejecutar pruebas unitarias
        run: |
          # Ejecutamos pytest.
          # Añadimos el directorio actual al PYTHONPATH para que los módulos del proyecto
          # (como 'voxflow_core') puedan ser importados correctamente por los archivos de prueba.
          PYTHONPATH=. pytest
